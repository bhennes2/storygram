<script type="text/javascript">
var tl;

// This is the function that loads the page
function onLoad() {


	  // make a custom map style
    var styledMapType = new google.maps.StyledMapType([
        {
            featureType: "water",
            elementType: "all",
            stylers: [
              { saturation: 0 },
              { lightness: 100 }
            ]
        },
        {
            featureType: "all",
            elementType: "all",
            stylers: [
              { saturation: -100 }
            ]
        }
    ], {
        name: "white"
    });
	
	tm = TimeMap.init({
        mapId: "map",               // Id of map div element (required)
        timelineId: "timeline",     // Id of timeline div element (required)
        
        datasets: [
            {
                data: {
				type: "basic",
                value: [
                        <% @media.each do |media| %>
			{
       			"start":"<%= Time.at(Integer(media.created_time)).iso8601 %>",
				"point": {				
						<% if media.location !=nil && media.location.latitude !=nil && media.location.longitude !=nil && media.caption != nil %>
							"lat": <%= media.location.latitude %>,
							"lon": <%= media.location.longitude %>
						<% end %>
				},
       			//TODO - Title might be on multiple lines!! This breaks the javascript object because the quotation mark isn't closed. I think we need to "fix" these in the controller before it gets this far
       			<% if media.caption !=nil %>
       				"title": "<%= media.caption.text.gsub(/\n/," ")%>",
            		"description":"<%= media.caption.text.gsub(/\n/," ") %>",
          		<% else %>
            		"title": "",
            		"description":"",
          		<% end %>
		  		"image" :"<%= media.images.thumbnail.url %>",
		  		"icon" :"<%= media.images.thumbnail.url %>",
		  		"link" :"<%= media.link %>",
				"options" : {
                            // set the full HTML for the info window
                            "infoHtml": "<img src=<%= media.images.thumbnail.url %> />"
                          },
       			'durationEvent':false // Notes: not "false". And no trailing comma.
     		}<% if media != @media.last %>,<%end%>
    		<% end %>
			                  
                    ]
                }
            }
        ],
        bandIntervals: [
            Timeline.DateTime.DAY, 
            Timeline.DateTime.MONTH
        ]
    });	

	// set the map to our custom style
    var gmap = tm.getNativeMap();
    gmap.mapTypes.set("white", styledMapType);
    gmap.setMapTypeId("white");
};



	/* Creating a timeline data object
	var timeline_data = {
  		'wiki-url':"http://simile.mit.edu/shelf/",
  		'wiki-section':"Simile JFK Timeline",
  		'dateTimeFormat': 'iso8601',
		//loading the 'events' array
  		'events': [

			<% @media.each do |media| %>
			{
       			'start':"<%= Time.at(Integer(media.created_time)).iso8601 %>",
       			//TODO - Title might be on multiple lines!! This breaks the javascript object because the quotation mark isn't closed. I think we need to "fix" these in the controller before it gets this far
       			<% if media.caption != nil %>
            		"title": "<%= media.caption.text %>",
            		"description":"<%= media.caption.text %>",
          		<% else %>
            		"title": "",
            		"description":"",
          		<% end %>
		  		"image" :"<%= media.images.thumbnail.url %>",
		  		//"icon" :"<%= media.images.thumbnail.url %> width='15' height='15'",
		  		"link" :"<%= media.link %>",
       			'durationEvent':false // Notes: not "false". And no trailing comma.
     		}<% if media != @media.last %>,<%end%>
    		<% end %>
  		]};

	  var eventSource = new Timeline.DefaultEventSource();

	  var theme1 = Timeline.ClassicTheme.create();
	  theme1.timeline_start = "<%= Time.at(@start_date).iso8601 %>";
	  theme1.timeline_stop = "<%= Time.at(@end_date).iso8601 %>";
	  theme1.autoWidth = true;

	  var bandInfos = [
	  	Timeline.createBandInfo({
	        timeZone:       -5,
			trackHeight:    1.0,
	        trackGap:       0.2,
	        eventSource:    eventSource,
	        date:           "<%= Time.at(@middle_date).iso8601 %>",
	        width:          "70%",
	        intervalUnit:   Timeline.DateTime.DAY,
	        intervalPixels: 100
	    }),
	    Timeline.createBandInfo({
			showEventText:  false,
	        trackHeight:    0.5,
	        trackGap:       0.2,
	        eventSource:    eventSource,
	        date:           "<%= Time.at(@middle_date).iso8601 %>",
	        width:          "30%",
	        intervalUnit:   Timeline.DateTime.MONTH,
	        intervalPixels: 100,
	        theme:          theme1
	    })
	  ];
	  bandInfos[1].syncWith = 0;
	  bandInfos[1].highlight = true;
	  bandInfos[1].eventPainter.setLayout(bandInfos[0].eventPainter.getLayout());



	  var url = "http://localhost:3000";

	  tl = Timeline.create(document.getElementById("timeline"), bandInfos);

	  eventSource.loadJSON(timeline_data, url);
	
	
//Google Maps
	  if (GBrowserIsCompatible()) {
			var map = new GMap2(document.getElementById('map'));
			map.enableScrollWheelZoom();
			map.addControl(new GLargeMapControl());


			var counter = 0;
			var point = new Array();
			var markerOptions;
			var marker = new Array();

			<% @media.each do |media| %>

				<% if media.location != nil && media.location.latitude != nil && media.location.longitude != nil && media.caption != nil %>

						point[counter] = new GLatLng(<%= media.location.latitude %>, <%= media.location.longitude %>);

						markerOptions = { title: "<%= media.caption.text %>" };


						marker[counter] = new GMarker(point[counter], markerOptions);
						map.addOverlay(marker[counter]);

						var location = marker[counter];
						var caption = "<%= media.caption.text %>";
						var html_popup = "<table><tr><td style='font-family:Arial, Helvetica, sans-serif; font-weight:bold; color:#FF0000; font-size:22px'><%= media.caption.title%></td></tr><tr><td><%= media.caption.text %></td></tr><tr><td align='center'><img src='<%= media.images.thumbnail.url %>' /></td></tr></table>";
						location.html_popup = html_popup;

						// need to escape when html characters used in caption

						GEvent.addListener(location, 'mouseover', function() {this.openInfoWindowHtml(this.html_popup)});

						counter++;
				<%end%>

			<% end %>

	        if (point != null && point.length > 0) {
	            map.setCenter(point[counter - 1], 11);
	        } else {
	            //default us to San Francisco
			    map.setCenter(new GLatLng(37.775196, -122.419204), 11);
	        }
			// This is a line connecting the points
			  //var polyline = new GPolyline(point, "#ff0000", 5);
			  //map.addOverlay(polyline);
			}

}

var resizeTimerID = null;
function onResize() {
    if (resizeTimerID == null) {
        resizeTimerID = window.setTimeout(function() {
            resizeTimerID = null;
            tl.layout();
        }, 500);
    }
}
*/
</script>

<!--
This displays the variable values for debugging purposes
Start:  <%=Time.at(@start_date)%>
End:  <%=Time.at(@end_date)%>
Middle:  <%= Time.at(@middle_date) %>
-->

<ul>
	<% @media.each do |media| %>
		<li>
			<a href="<%= media.images.standard_resolution.url %>" rel="lightbox" title="<% if !media.caption.nil?%><%= media.caption.text %><% end %>" rev="targetdiv:loadarea2,trigger:click,preload:none,fx:fade">
				<img src="<%= media.images.thumbnail.url %>" width="120" height="120" onclick="close" />
			</a>
		</li>
	<% end %>
</ul>